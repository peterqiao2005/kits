#!/usr/bin/env bash
set -e

SSH_DIR="$HOME/.ssh"
KEY_PATH="$SSH_DIR/pq_github"
CONFIG_FILE="$SSH_DIR/config"

GITHUB_USER="peterqiao2005"
GITHUB_EMAIL="peterqiao2005@gmail.com"

echo "[1/5] 检查 ~/.ssh 目录"
if [ ! -d "$SSH_DIR" ]; then
    echo "❌ $SSH_DIR 不存在，请先创建并放置私钥文件"
    exit 1
fi

echo "[2/5] 检查 GitHub SSH 私钥是否存在"
if [ ! -f "$KEY_PATH" ]; then
    echo "❌ 私钥不存在: $KEY_PATH"
    exit 1
fi

echo "[3/5] 设置 SSH 权限"
chmod 700 "$SSH_DIR"
chmod 600 "$KEY_PATH"

echo "[4/5] 配置 ~/.ssh/config（仅 github.com）"
if [ ! -f "$CONFIG_FILE" ]; then
    touch "$CONFIG_FILE"
fi

if ! cat "$CONFIG_FILE" | grep -q "^Host github.com"; then
cat >> "$CONFIG_FILE" <<EOF

Host github.com
    HostName github.com
    User git
    IdentityFile $KEY_PATH
    IdentitiesOnly yes
EOF
fi

chmod 600 "$CONFIG_FILE"

echo "[5/5] 配置 git 用户信息"
git config --global user.name "$GITHUB_USER"
git config --global user.email "$GITHUB_EMAIL"

echo
echo "完成。验证："
echo "ssh -T git@github.com"
