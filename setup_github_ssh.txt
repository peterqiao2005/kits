#!/usr/bin/env bash
set -e

KEY_PATH="$HOME/.ssh/peterqiao0612"
PUB_KEY_PATH="$HOME/.ssh/peterqiao0612.pub"
SSH_DIR="$HOME/.ssh"
CONFIG_FILE="$SSH_DIR/config"

GITHUB_USER="peterqiao2005"
GITHUB_EMAIL="peterqiao2005@gmail.com"

echo "[1/6] 检查 ~/.ssh 目录"
if [ ! -d "$SSH_DIR" ]; then
    echo "❌ $SSH_DIR 不存在，请先创建并放置密钥文件"
    exit 1
fi

echo "[2/6] 检查 SSH key 是否存在"
if [ ! -f "$KEY_PATH" ]; then
    echo "❌ 私钥不存在: $KEY_PATH"
    echo "请先将现有 SSH 私钥放置到该路径后再执行脚本"
    exit 1
fi

if [ ! -f "$PUB_KEY_PATH" ]; then
    echo "❌ 公钥不存在: $PUB_KEY_PATH"
    echo "请确认密钥对完整"
    exit 1
fi

echo "[3/6] 设置 SSH 目录与 key 权限"
chmod 700 "$SSH_DIR"
chmod 600 "$KEY_PATH"
chmod 644 "$PUB_KEY_PATH"

echo "[4/6] 配置 ~/.ssh/config（仅 GitHub）"
if [ ! -f "$CONFIG_FILE" ]; then
    touch "$CONFIG_FILE"
fi

if ! cat "$CONFIG_FILE" | grep -q "^Host github.com"; then
cat >> "$CONFIG_FILE" <<EOF

Host github.com
    HostName github.com
    User git
    IdentityFile $KEY_PATH
    IdentitiesOnly yes
EOF
fi

chmod 600 "$CONFIG_FILE"

echo "[5/6] 配置 git 全局用户信息"
git config --global user.name "$GITHUB_USER"
git config --global user.email "$GITHUB_EMAIL"

echo "[6/6] 启动 ssh-agent 并加载 key"
eval "$(ssh-agent -s)"
ssh-add "$KEY_PATH"

echo
echo "================= 当前使用的 GitHub 公钥 ================="
cat "$PUB_KEY_PATH"
echo "========================================================="
echo

echo "配置完成，可执行以下命令验证："
echo "ssh -T git@github.com"
